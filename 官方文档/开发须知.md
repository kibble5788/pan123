# 123云盘开放平台开发须知
## 一、注意事项
1. 调用服务端接口时，需使用 HTTPS 协议、JSON 数据格式、UTF-8 编码，POST 请求请在 HTTP Header 中设置 `Content-Type:application/json`。
2. 接口域名为：`https://open-api.123pan.com`
3. 分配的 `client_secret` 请注意安全保存，不要放在前端代码里，泄露后请联系客服更换。
4. 所有请求接口均需要带上请求头 `platform` 值为: `open_platform`
5. 开放平台发放的 Access Token 也将作为设备计算。同一时刻只允许 `client_id` 下最多 3 个 token 正在使用。多次颁发会存在将 Token 踢下线的情况。颁发后的 Token 有效期为 30 天。

## 二、公共请求头
| 请求头名称 | 是否必填 | 类型 | 示例值 | 描述 |
| ---- | ---- | ---- | ---- | ---- |
| Authorization | 是 | string | Bearer access_token | 注意格式：Bearer + 空格 + access_token |
| Platform | 是 | string | open_platform | 固定值：open_platform |
| Content-Type | 是 | string | application/json | 固定值：application/json |

## 三、接口身份校验示例
开放 API 的 HTTP 调用，需在 Header 中传递 Authorization 参数，值为 `token_type + 空格 + access_token`。

## 四、接口响应参数
| 参数名称 | 是否必填 | 类型 | 示例值 | 描述 |
| ---- | ---- | ---- | ---- | ---- |
| code | 是 | int | 0 | code 字段等于 0 标识成功响应，其他 code 为失败响应 |
| message | 是 | string | ok | 请求成功为 ok；异常时为具体异常信息 |
| data | 是 | any | - | 返回的响应内容；异常时为 null |
| x-traceID | 是 | string | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9 | 接口响应异常需要技术支持请提供接口返回的 x-traceID |

## 五、接口响应示例说明
所有 API 的响应体中都包含 `code`、`message`、`data` 字段，`data` 字段的数据结构请查看具体接口的文档。API 都使用返回的 `code` 字段等于 0 标识成功响应，其他 `code` 为失败响应，请根据响应的 `code` 和 `message` 排查错误具体原因。如果接口响应异常需要技术支持请提供接口返回的 `x-traceID`。

## 六、常用 code 码
| body 中的 code | 描述 |
| ---- | ---- |
| 401 | access_token 无效 |
| 429 | 请求太频繁 |

## 七、限流处理
为确保所有用户的使用体验，123 云盘开放平台会对以下 API 进行限流：

| API | 免费用户 QPS | 会员用户 QPS |
| ---- | ---- | ---- |
| api/v1/user/info | 10 | 10 |
| api/v1/file/move | 3 | 10 |
| api/v1/file/delete | 1 | 10 |
| api/v1/file/list | 0.2 | 10 |
| api/v2/file/list | 5 | 10 |
| upload/v1/file/mkdir | 5 | 20 |
| api/v1/access_token | 8 | 10 |
| api/v1/transcode/folder/info | 20 | 20 |
| api/v1/transcode/upload/from_cloud_disk | 1 | 1 |
| api/v1/transcode/delete | 10 | 10 |
| api/v1/transcode/video/resolutions | 1 | 1 |
| api/v1/transcode/video | 3 | 3 |
| api/v1/transcode/video/record | 20 | 20 |
| api/v1/transcode/video/result | 20 | 20 |
| api/v1/transcode/file/download | 10 | 10 |
| api/v1/transcode/m3u8_ts/download | 20 | 20 |
| api/v1/transcode/file/download/all | 1 | 1 |

> 文档来源：123云盘 10-28 10:41


# 123云盘上传流程说明
## 一、分片上传
### （一）创建文件
1. 调用创建文件接口，若接口返回的 `reuse` 为 `true`，表示秒传成功，上传结束。
2. 非秒传情况：接口会返回预上传ID（`preuploadID`）与分片大小（`sliceSize`），需将文件按照该分片大小进行切分；同时返回 `servers`（后续上传文件的对应域名，多个可任选其一）。

### （二）上传分片
1. 准备工作：按照 `sliceSize` 切分文件，并计算每个分片的 MD5。
2. 调用上传分片接口，传入对应参数，需注意此步骤的 `Content-Type` 为 `multipart/form-data`。

### （三）上传完毕
1. 调用上传完毕接口，若接口返回的 `completed` 为 `true` 且 `fileID` 不为 0，说明上传完成。
2. 若接口返回的 `completed` 为 `false`，需间隔 1 秒继续轮询该接口，直至获取上传最终结果。

## 二、单步上传
### （一）获取上传域名
调用对应接口，在返回结果中获取多个上传域名，后续上传任务需使用这些域名。

### （二）发起上传
1. 计算文件的 MD5；
2. 使用获取到的上传域名发起上传；
3. 注意此步骤的 `Content-Type` 为 `multipart/form-data`。

## 三、上传文件时序图关键流程
1. 发起上传（openapi 上传服务/Alt 发起上传）；
2. 秒传场景：返回文件信息，上传结束；
3. 非秒传场景：返回上传信息（含单个分片大小等）；
4. 计算分片 MD5，携带分片二进制流；
5. 校验分片 MD5；
6. 分片上传完成；
7. 调用上传完毕接口；
8. 若 `completed` 为 `true` 且 `fileID` 不为 0，完成上传；
9. 若 `completed` 为 `false`，继续轮询上传完毕接口。